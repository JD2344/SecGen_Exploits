# Class: linuxki::apache
# Apache configuration for linuxki
#
class linuxki_rce::apache {
  Exec { path => ['/bin', '/usr/bin', '/usr/local/bin', '/sbin', '/usr/sbin'] }

  file { '/etc/apache2/sites-enabled/000-default.conf':
    ensure => 'absent',
  }
  $dirmatch = "
  <Directory /var/www/>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
  </Directory>
  
  <Directory /opt/>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
  </Directory>"

  $httpdconf = file('/etc/apache2/apache2.conf')
  # Searches a string for an XML match of <Directory /a/path/here>
  $matches = $httpdconf.match(/<Directory \/>/)

  class { '::apache':
    default_vhost   => false,
    default_mods    => ['rewrite'], # php5 via separate module
    overwrite_ports => false,
    mpm_module      => 'prefork',
  }
  -> ::apache::vhost { 'linuxki':
    port        => '80',
    options     => 'FollowSymLinks',
    override    => 'All',
    docroot     => '/opt/',
    directories => [{
      path  => '/opt/',
      allow => 'from all',
    },{
      path  => '/opt/linuxki/',
      allow => 'from all',
    }],
  }
  # ugly way to append to the file... clean up potentially?
  -> if length($matches) == 1 {
    exec { 'append-directories':
      command   => "echo '${dirmatch}' | tee -a /etc/apache2/apache2.conf",
    }
  }
  # restart apache
  -> exec { 'restart-apache-linuxki':
    command   => 'service apache2 restart',
    logoutput => true
  }
  -> exec { 'wait-apache-linuxki':
    command => 'sleep 4',
  }
}
