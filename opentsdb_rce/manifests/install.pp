# Class: opentsdb_rce::install
# install process for opentsdb
#
class opentsdb_rce::install {
  Exec { path => [ '/bin/', '/sbin/' , '/usr/bin/', '/usr/sbin/' ] }

  $jdkhome='\/usr\/lib\/jvm\/java-8-openjdk-amd64\//'

  $jdkdirs="JDK_DIRS=\"/usr/lib/jvm/java-8-oracle /usr/lib/jvm/java-8-openjdk \
  ${jdkhome} /usr/lib/jvm/java-8-openjdk-i386/ \
   /usr/lib/jvm/java-7-oracle /usr/lib/jvm/java-7-openjdk \
   /usr/lib/jvm/java-7-openjdk-amd64/ /usr/lib/jvm/java-7-openjdk-i386/ \
   /usr/lib/jvm/java-6-sun /usr/lib/jvm/java-6-openjdk \
   /usr/lib/jvm/java-6-openjdk-amd64 /usr/lib/jvm/java-6-openjdk-i386 \
   /usr/lib/jvm/default-java\""

  # This generates a repo file so we can get packages from debian stretch
  file { '/etc/apt/sources.list.d/stretch.list':
    ensure => file,
    source => 'puppet:///modules/apache_druid_rce/stretch.list'
  }
  -> exec { 'update-packages':
    command => 'apt update'
  }
  -> package { 'install-jdk8':
    ensure => 'installed',
    name   => 'openjdk-8-jdk',
  }
  -> package { 'gnuplot':
    ensure => 'installed',
    name   => 'gnuplot',
  }

  file { '/usr/local/share/hbase-0.98.24-hadoop2-bin.tar.gz':
    ensure => file,
    source => 'puppet:///modules/opentsdb_rce/hbase-0.98.24-hadoop2-bin.tar.gz',
  }
  -> exec { 'extract-hbase':
    cwd     => '/usr/local/share/',
    command => 'tar -xvf hbase-0.98.24-hadoop2-bin.tar.gz',
  }
  -> exec { 'chmod-hbase':
    command => 'chmod 755 -R hbase-0.98.24-hadoop2'
  }
  -> exec { 'set-javahome':
    command => "sed -i 's/# export JAVA_HOME=\/usr\/java\/jdk1.6.0\// export JAVA_HOME=${jdkhome}' conf/hbase-env.sh"
  }
  -> file { 'remove-hbase-tar':
    ensure => absent,
    path   => '/usr/local/share/hbase-0.98.24-hadoop2-bin.tar.gz'
  }

  file { '/tmp/opentsdb-2.3.0_all.deb':
    ensure => file,
    source => 'puppet:///modules/opentsdb_rce/opentsdb-2.3.0_all.deb',
  }
  -> package { 'opentsdb':
    ensure   => 'installed',
    provider => 'dpkg',
    source   => '/tmp/opentsdb-2.3.0_all.deb'
  }
  -> exec { 'replace-service-dirs':
    command => "sed -i 's/JDK_DIRS=\"\/[\w\/-\s\\]+\"/${jdkdirs}' /etc/init.d/opentsdb.service"
  }
  -> exec { 'reload-systemd-daemons':
    command => 'systemctl daemon reload'
  }
}
